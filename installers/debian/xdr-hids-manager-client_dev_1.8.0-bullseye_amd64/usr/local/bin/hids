#!/usr/bin/env python3

# Copyright   : Whizhack Technologies Pvt Ltd
# Author      : Amisha Prashar, Nikhilesh Kumar
# Description : This an the automation script for xdr-hids-manager version 1.8.0 installation.
# Usage       : Run this script using command sudo xdr [options], for options see the "read_me" section 
# Version     : 1.8.0

import subprocess
import sys
import yaml
import configparser
import psycopg2
import random
import ast
import string
import requests
import time
import os

# Helping section for xdr-hids-manager version 1.8.0 installation
def read_me():
    print('''
=======================================================================================
Welcome to XDR Automated Installer Help Section:-                                      
Available Flag Options are below :                                                      
                                                                                       
-i | install              : Fresh Installation of xdr-hids-manager version 1.8.0        
-u | uninstall            : Uninstall xdr-hids-manager version 1.8.0 
-r | reconfigure          : Reconfigure xdr-hids-manager version 1.8.0                   
-h | help                 : Help Section for xdr-hids-manager version 1.8.0             
=======================================================================================
     ''')
 
# Converting .yaml file to .conf file.           
def create_conf_file(yaml_file_path, conf_file_path, section_name):
    with open(yaml_file_path, 'r') as yaml_file:
        config = yaml.safe_load(yaml_file)

    with open(conf_file_path, 'w') as conf_file:
        conf_file.write(f"[{section_name}]\n")
        for key, val in config.items():
            conf_file.write(f"{key}={val}\n")
        conf_file.write("\n")
        
# Converting config.yml into config.env file.
def create_env_file(yaml_file_path, env_file_path):
    with open(yaml_file_path, 'r') as yaml_file:
        config = yaml.safe_load(yaml_file)

    with open(env_file_path, 'w') as env_file:
        for key, val in config.items():
            env_file.write(f"{key}={val}\n")
            
# Initializing xdr-hids-manager.service
def service_init():
    print("[i] Initializing xdr-hids-manager.service. This usually takes around 5 minutes. If it takes longer then you have internet issues. (The duration can be longer for active directory services)")
    subprocess.run(["sudo", "systemctl", "start", "xdr-hids-manager"])
    print("[i] xdr-hids-manager.service successfully initialized.")
    subprocess.run(["sudo", "systemctl", "enable", "xdr-hids-manager"])
    print("[i] xdr-hids-manager.service successfully enabled.")
    subprocess.run(["sudo", "systemctl", "start", "xdr-hids-health"])
    print("[i] xdr-hids-health.service successfully initialized.")
    subprocess.run(["sudo", "systemctl", "enable", "xdr-hids-health"])
    print("[i] xdr-hids-health.service successfully enabled.")

# Configuring AWS
def aws_setup():
    # Loading the YAML file
    with open('/etc/zh-xdr-hids-manager-client/config.yml', 'rb') as f:
        config = yaml.safe_load(f)
    
    # Accessing the variables
    aws_default_region = config['XDR_DEFAULT_REGION']
    access_key_id = config['ACCESS_ID']
    secret_access_key = config['ACCESS_KEY']
    
    # Configuring the awscli to use the provided credentials.
    subprocess.run(["sudo", "aws", "configure", "set", "region", aws_default_region])
    subprocess.run(["sudo", "aws", "configure", "set", "aws_access_key_id", access_key_id])
    subprocess.run(["sudo", "aws", "configure", "set", "aws_secret_access_key", secret_access_key])
    login_pass = subprocess.check_output(["sudo", "aws", "ecr", "get-login-password", "--region", "us-east-2"]).decode("utf-8")
    subprocess.check_call(["sudo", "docker", "login" , "-u", "AWS" , "406116439221.dkr.ecr.us-east-2.amazonaws.com" , "--password", login_pass])

def get_service_status():
    try:
        # Use the 'systemctl' command to check the service status
        status1 = os.system(f'sudo systemctl is-active --quiet xdr-hids-manager')
        status2 = os.system(f'sudo systemctl is-active --quiet xdr-hids-health')
        if status1 == 0 and status2 == 0:  #768 means not runnning, 0 means runnng
            print("[i] Both services are running.")
            ############# sensor active count ##############
            yaml_file_path = '/etc/zh-xdr-hids-manager-client/config.yml'
            with open(yaml_file_path, 'r') as config_file:
                config = yaml.safe_load(config_file)
            sensorkey = config['SENSOR_ACCESS_ID']
            control_server_domain = config['CONTROL_SERVER_DOMAIN']
            api_url = f'{control_server_domain}/api/multiple-decrease-license-count'
            headers = {
                'sensorkey': sensorkey ,
                'deccount': '1'
            }
            response = requests.post(api_url, headers=headers)
            ##################################################
        else:
            print("[i] One or both services are not running.")
    except subprocess.CalledProcessError as e:
        # Handle the case when the service is not found or other errors occur
        return f"Error: {e}"

# Installing xdr-hids-manager version 1.8.0  
def install():
    yaml_file_path = '/etc/zh-xdr-hids-manager-client/config.yml'
    env_file_path = '/etc/zh-xdr-hids-manager-client/config.env'
    file_name = '/usr/local/bin/healthcheck'
    subprocess.run(['sudo', 'chmod', '+x', file_name], check=True)
    license_check(yaml_file_path)
    try:
        # Prompting the user to fill the configuration file
        response = input("File named 'config.yml' located at /etc/zh-xdr-hids-manager-client/ is configured? (Y/n) ")

        if response == "Y" or response == "y" or response == "":
            print("[i] Initializing the installation process")
            create_env_file(yaml_file_path, env_file_path)  
            aws_setup()
            hids_directory()
            service_init()
            time.sleep(30)
            host_database_setup()
            time.sleep(60)
            get_service_status()
            print("[i] Installation process completed successfully.")
            print("[i] You can run 'sudo docker ps' to check the running containers.")
            print("[i] Meanwhile, you can access XDR threat dashboard at https://xdr.zerohack.in.")
        else:
            print("[!] Kindly fill the configuration file located at /etc/zh-xdr-hids-manager-client/config.yml")
            exit()
    except Exception as e:
        print("[!] An error occurred during the installation process:")
        print(e)
        
# Uninstalling xdr-hids-manager version 1.8.0  
def uninstall():
    try:    
        #Prompting the user to fill the configuration file
        response = input("Do you want to uninstall the xdr-hids setup? (Y/n) ")

        if response == "Y" or response == "y":
            print("[i] Initializing the uninstallation process")
        filename  = '/etc/zh-xdr-hids-manager-client/config.yml'
        with open(filename, 'r') as config_file:
            config = yaml.safe_load(config_file)
        sensorkey = config['SENSOR_ACCESS_ID']
        control_server_domain = config['CONTROL_SERVER_DOMAIN']
        api_url = f'{control_server_domain}/api/multiple-decrease-license-count'
        headers = {
            'sensorkey': sensorkey ,
            'inccount': '1'
        }
        response = requests.post(api_url, headers=headers)
        subprocess.run(["sudo", "rm", "-r", "/etc/zh-xdr-hids-manager-client"])
        subprocess.run(["sudo", "rm", "-r", "/opt/zh-xdr-hids-manager-client"])
        subprocess.run(["sudo", "rm", "-r", "/opt/wazuh_manager"])
        subprocess.run(["sudo", "apt", "autopurge", "zh-xdr-hids-manager-client"])
    except Exception as e:
            print("[!] An error occurred during the installation process:")
            print(e)      

def reconfigure():
    try:    
        #Prompting the user to fill the configuration file
        response = input("Do you want to reconfigure the xdr-hids setup? (Y/n) ")

        if response == "Y" or response == "y":
            print("[i] Initializing the reconfigure process..")
            # providing file paths and creating config.env file
            yaml_file_path = '/etc/zh-xdr-hids-manager-client/config.yml'
            env_file_path = '/etc/zh-xdr-hids-manager-client/config.env'
            create_env_file(yaml_file_path, env_file_path)   
            credential_refresh()    
            aws_setup()
            subprocess.run(["sudo", "systemctl", "restart", "xdr-hids-manager"])
            subprocess.run(["sudo", "systemctl", "restart", "xdr-hids-health"])
            print("[i] Reconfigure process completed successfully.")
            print("[i] You can run 'sudo docker ps' to check the running containers.")
            print("[i] Meanwhile, you can access XDR threat dashboard at https://xdr-demo.zerohack.in.")
        else:
            print("[!] Kindly fill the configuration file located at /etc/zh-xdr-hids-manager-client/config.yml")
            exit()
    except Exception as e:
            print("[!] An error occurred during the installation process:")
            print(e)        
            
# Updating aws credentials 
def credential_refresh():
    # Loading the YAML file
    with open('/etc/zh-xdr-hids-manager-client/config.yml', 'rb') as f:
        config = yaml.safe_load(f)
    
    # Accessing the variables
    aws_default_region = config['XDR_DEFAULT_REGION']
    repository = config['REGISTRY_SERVER']
    
    # Updating the awscli.
    subprocess.run(["sudo", "/aws/install", "--update"], check=True)
    get_login_cmd   = ["sudo", "aws", "ecr", "get-login-password", "--region", aws_default_region]
    login_cmd       = ["sudo", "docker", "login", "--username", "AWS", "--password-stdin", repository]

    get_login_password_process = subprocess.Popen(get_login_cmd, stdout=subprocess.PIPE)
    password, _ = get_login_password_process.communicate()

    login_process = subprocess.Popen(login_cmd, stdin=subprocess.PIPE)
    login_process.communicate(input=password)            

# Setting up the xdr-hids-host database 
def host_database_setup():
    time.sleep(30)
    # Database connection settings
    db_settings = {
        'dbname': 'mydatabase',
        'user': 'host',
        'password': 'mypassword',
        'host': 'localhost',   
        'port': '5432'         
    }
    try:
        conn = psycopg2.connect(**db_settings)
        print("[i] Successfully connected to the database")
        cur = conn.cursor()
        # SQL statement to create the table
        create_table_query = """
        CREATE TABLE IF NOT EXISTS xdr_hids (
            xdr_hids_status VARCHAR(255)
        )
        """
        # Execute the CREATE TABLE statement
        cur.execute(create_table_query)
        # Commit the changes
        conn.commit()
        print("[i] Table created successfully!")
        status = "active"
        cur.execute("INSERT INTO xdr_hids (XDR_HIDS_STATUS) VALUES (%s)", (status,))
        # Commit the changes
        conn.commit()
        print("[i] Data inserted successfully!")
    except (Exception, psycopg2.Error) as error:
        print("Error: Unable to connect to the database")
        print(e)
    finally:
        cur.close()
        conn.close()

# Genearting Random ID
def random_id():
    characters = string.ascii_letters + string.digits
    random_string = ''.join(random.choice(characters) for _ in range(10))
    return random_string

# Checking License
def license_check(yaml_file_path):
    # This license check function is checking whether the particular access key is allowed for installing the xdr-hids-manager or not. 
    # If the access key matches with the key present in our database then only installation process intializes.
    # In case of mismatch, user/client will not be able to install the package.
    
    with open(yaml_file_path, 'r') as config_file:
        config = yaml.safe_load(config_file)
    if 'SENSOR_ACCESS_ID' in config:
        sensorkey = config['SENSOR_ACCESS_ID']
        control_server_domain = config['CONTROL_SERVER_DOMAIN']
    else:
        sensorkey = None
    api_url = f'{control_server_domain}/api/display-multiple-decrease-license-count'
    headers = {"sensorkey": sensorkey}
    response = requests.get(api_url, headers=headers)

    if response.status_code == 200:
        api_data = response.json()
        for key in api_data:
            if key == "HIDS":
                api_key = key
        dict = api_data[api_key]
        aggregator_domain = dict['aggregator_domain']
        aggregator_port = dict['aggregator_port']
        sensor_type = dict['sensor_type']
        registry_server = dict['registry_server']
        access_id = dict['access_id']
        access_key = dict['access_key']
        edition = dict['edition']
        location = dict['location']
        client_city = dict['client_city']
        client_latitude = dict['client_latitude']
        client_longitude = dict['client_longitude']
        client_country_code = dict['client_country_code']
        client_country_name = dict['client_country_name']
        license_start_date = dict['license_start_date']
        license_end_date = dict['license_end_date']
        xdr_hids_status = dict['xdr_hids_status']
        data_sharing_mode = dict['data_sharing_mode']
        operating_env = dict['operating_env']
        sensor_create_count = dict['sensor_create_count']
        xdr_default_region = dict['xdr_default_region']
        company_index_name = dict['company_index_name']
        sensor_name = "hids-sensor"
        sensor_id = random_id()
         
        if xdr_hids_status == 'active':
            # Reading the original config.yml content
            with open(yaml_file_path, 'r') as config_file:
                config_content = config_file.read()

            # Defining the keys you want to update and their corresponding values
            keys_to_update = {
                "AGGREGATOR_DOMAIN: \"\"": f"AGGREGATOR_DOMAIN: \"{aggregator_domain}\"",
                "AGGREGATOR_PORT: \"\"": f"AGGREGATOR_PORT: \"{aggregator_port}\"",
                "SENSOR_TYPE: \"\"": f"SENSOR_TYPE: \"{sensor_type}\"",
                "SENSOR_NAME: \"\"": f"SENSOR_NAME: \"{sensor_name}\"",
                "REGISTRY_SERVER: \"\"": f"REGISTRY_SERVER: \"{registry_server}\"",
                "ACCESS_ID: \"\"": f"ACCESS_ID: \"{access_id}\"",
                "ACCESS_KEY: \"\"": f"ACCESS_KEY: \"{access_key}\"",
                "EDITION: \"\"": f"EDITION: \"{edition}\"",
                "LOCATION: \"\"": f"LOCATION: \"{location}\"",
                "CLIENT_CITY: \"\"": f"CLIENT_CITY: \"{client_city}\"",
                "CLIENT_LATITUDE: \"\"": f"CLIENT_LATITUDE: \"{client_latitude}\"",
                "CLIENT_LONGITUDE: \"\"": f"CLIENT_LONGITUDE: \"{client_longitude}\"",
                "CLIENT_COUNTRY_CODE: \"\"": f"CLIENT_COUNTRY_CODE: \"{client_country_code}\"",
                "CLIENT_COUNTRY_NAME: \"\"": f"CLIENT_COUNTRY_NAME: \"{client_country_name}\"",
                "LICENSE_START_DATE: \"\"": f"LICENSE_START_DATE: \"{license_start_date}\"",
                "LICENSE_END_DATE: \"\"": f"LICENSE_END_DATE: \"{license_end_date}\"",
                "XDR_HIDS_STATUS: \"\"": f"XDR_HIDS_STATUS: \"{xdr_hids_status}\"",
                "DATA_SHARING_MODE: \"\"": f"DATA_SHARING_MODE: \"{data_sharing_mode}\"",
                "OPERATING_ENV: \"\"": f"OPERATING_ENV: \"{operating_env}\"",
                "SENSOR_CREATE_COUNT: \"\"": f"SENSOR_CREATE_COUNT: \"{sensor_create_count}\"",
                "XDR_DEFAULT_REGION: \"\"": f"XDR_DEFAULT_REGION: \"{xdr_default_region}\"",
                "COMPANY_INDEX_NAME: \"\"": f"COMPANY_INDEX_NAME: \"{company_index_name}\"",
                "SENSOR_ID: \"\"": f"SENSOR_ID: \"{sensor_id}\""
            }

            # Updating the values in the content
            updated_content = config_content
            for old_key, new_key in keys_to_update.items():
                updated_content = updated_content.replace(old_key, new_key)

            # Writing the updated content back to the file
            with open(yaml_file_path, 'w') as config_file:
                config_file.write(updated_content)
            print("Info: Config.yml updated with data from the database.")
        else:
            print("Info: Invalid ID Provided.")  
            sys.exit()  
    else:
        print(f"Failed to retrieve data. Status code: {response.status_code}")
        sys.exit()         
            
def hids_directory():
    directory_path = "/opt/wazuh_manager"
    try:
        subprocess.run(f'mkdir -p {directory_path}', shell=True, check=True)
    except subprocess.CalledProcessError:
        print(f"Failed to create directory '{directory_path}'.")  
          
# Main Function  
def main():
    n = len(sys.argv)
    if n == 1:
        read_me()
    elif n == 2:  
        arg = sys.argv[1]
        if arg in ("-i", "install"): 
            install()
            sys.exit()
        elif arg in ("-u", "uninstall"):
            uninstall()
            sys.exit()
        elif arg in ("-r", "reconfigure"):
            reconfigure()
            sys.exit()    
        elif arg in ("-h", "help"):
            read_me()
            sys.exit()
               
# Calling Main Function        
main()

